abaixo tem um exemplo de funÃ§Ã£o no puppeteer. vou explicar o que eu quero:

1- adicionar ao lado do botao visualizar (esquerdo) um botao Gerar contrato.
2- Ao clicar, tem que verificar quais variaveis esse template usa.
3- abrir um modal assim:

________________________________________________
|                                               |
|                Gerar Contrato                 |
|                                               |
|  Selecione as atribuiÃ§Ãµes para cada variavel  |
|        ________                               |
|  Nome  |______|                               |
|        ________                               |
|  Lista |______|                               |
|                                               |
|                                               |
|                       Cancelar      Gerar     |
|_______________________________________________|


Vai fazer um map de todas as variaveis, trazendo o nome dela e ao lado um Select com as opÃ§Ãµes: Texto, Tabela, Varios Textos, Imagem.

ao selecionar uma opÃ§Ã£o, dependendo da opÃ§Ã£o vai abrir embaixo dessa linha algo a ser preenchido:

Texto: abre um input de Texto.
Varios Textos: Vai abrir um input editor de texto e um + pra adicionar quantos textos precisarem.
Imagem: Vai abrir um input que permite selecioanr uma rquivo PNG, JPG, JPEG.
Tabela: Vai abrir um input editor com uma tabela com duas colunas e duas linhas, mas com um + ao lado de colunas pra mais colunas e outro pra mais linhas

esse conteudo tem que ser salvo em variavel como html, com os estilos e tudo como escolhido e feito.
Texto: '<p>Texto</p>'
Varios Textos: '<p>Texto</p>, Texto: '<p>Texto</p>', Texto: '<p>Texto</p>', Texto: '<p>Texto</p>''
Imagem: '<img>Imagem</img>'
Tabela: '<ul>Tabela</ul>'


(A PARTIR DAQUI TUDO NO BACKEND)
passar para o back os dados tipo asim:

PAYLOAD:

{
  id_empresa: 1,
  "template": {id: 1, content: "<html>{{nome}}{{map_nomes}}{{foto_cliente}}{{tabela_precos}}</html>"},
  "variaveis": {
    "nome": "<p>Texto</p>"
    "map_nomes": '<p>Texto</p>, Texto: '<p>Texto</p>', Texto: '<p>Texto</p>', Texto: '<p>Texto</p>''
    "foto_cliente": '<img>Imagem</img>'
    "tabela_precos": '<ul>Tabela</ul>'
  }
}

ou seja, passa o template em template e as variaveis em variaveis...

usa o puppeteer pra montar o PDF, salva o pdf em uma pasta no backend, pdoe ser em alguma pasta public/documentos/[id], o id da empresa... e salva na tabela contratos do banco de dados:

{
  id_empresa: 1,
  id_template: 1,
  content: "endereÃ§o do pdf no backend",
  data_enviado: date now()
}

MUda tambem o nome da tabela contratos para documentos...

Dai retorna pro front esse PDF, fecha o modal de variaveis (estava em loading)... e abre outro modal, com um visualizador de PDF pro clliente visualizar o Pdf, usa aquele visualizador padrao, que ja tem imprimir, exportar tudo ali...



Abaixo um exemplo de outra API, mas vocÃª vai ter que modificar isso tudo aqui pra funcionar no formato que eu disse...


const Handlebars = require('handlebars');

function gerarTabelaAutomatica(array) {
  if (!Array.isArray(array) || array.length === 0) return '';

  const colunas = Object.keys(array[0]);

  const thead = colunas
    .map(col => `<th>${Handlebars.escapeExpression(col)}</th>`)
    .join('');

  const tbody = array
    .map(item => `
      <tr>
        ${colunas.map(col => `<td>${item[col] ?? ''}</td>`).join('')}
      </tr>
    `)
    .join('');

  return `
    <table border="1" cellpadding="5" cellspacing="0" width="100%">
      <thead><tr>${thead}</tr></thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
}


function processarVariaveis(variaveis) {
  const contexto = {};

  for (const [key, value] of Object.entries(variaveis || {})) {

    // ðŸ”¹ ARRAY
    if (Array.isArray(value)) {

      // map_ â†’ apenas injeta HTML
      if (key.startsWith('map_')) {
        contexto[key] = new Handlebars.SafeString(
          value.join('')
        );
        continue;
      }

      // array de objetos â†’ tabela automÃ¡tica
      if (typeof value[0] === 'object') {
        contexto[key] = new Handlebars.SafeString(
          gerarTabelaAutomatica(value)
        );
        continue;
      }

      // array simples â†’ lista
      contexto[key] = value.join(', ');
      continue;
    }

    // ðŸ”¹ IMAGEM (URL ou base64)
    if (
      typeof value === 'string' &&
      (value.startsWith('http') || value.startsWith('data:image'))
    ) {
      contexto[key] = value;
      continue;
    }

    // ðŸ”¹ STRING / NUMBER / BOOLEAN
    contexto[key] = value;
  }

  return contexto;
}

const puppeteer = require('puppeteer');

async function gerarPdfDinamico({ html, variaveis }) {
  const template = Handlebars.compile(html, { noEscape: true });

  const contexto = processarVariaveis(variaveis);

  const htmlFinal = template(contexto);

  const browser = await puppeteer.launch({
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });

  const page = await browser.newPage();
  await page.setContent(htmlFinal, { waitUntil: 'networkidle0' });

  const pdf = await page.pdf({
    format: 'A4',
    printBackground: true
  });

  await browser.close();

  return pdf;
}

